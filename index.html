<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>D&D Campaign Map with Quests</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    display: flex;
    height: 100vh;
  }
  #quest-log {
    width: 250px;
    border-right: 1px solid #ccc;
    padding: 10px;
    overflow-y: auto;
    background: #f9f9f9;
  }
  #quest-log h2 {
    margin-top: 0;
  }
  #quests {
    margin-top: 10px;
  }
  .quest {
    border: 1px solid #aaa;
    border-radius: 4px;
    padding: 6px;
    margin-bottom: 6px;
    background: #fff;
    cursor: pointer;
  }
  .quest.completed {
    background: #d4ffd4;
    text-decoration: line-through;
  }
  #map-container {
    flex: 1;
    position: relative;
  }
  #map {
    width: 100%;
    height: 100%;
  }
  #dm-toggle {
    position: absolute;
    top: 10px; left: 10px;
    z-index: 1000;
    padding: 8px 12px;
    background: #fff;
    border: 1px solid #ccc;
    cursor: pointer;
  }
  #dm-form {
    position: absolute;
    top: 50px; left: 10px;
    z-index: 1000;
    background: #fff;
    padding: 10px;
    border: 1px solid #ccc;
    max-width: 300px;
    display: none;
  }
  #dm-form label {
    display: block;
    margin-top: 8px;
  }
  #dm-form input[type=text] {
    width: 100%;
    padding: 4px;
    box-sizing: border-box;
  }
  #dm-form button {
    margin-top: 10px;
  }

  /* Star icon for quest marker */
  .star-icon {
    font-size: 24px;
    color: gold;
    text-shadow: 1px 1px 2px black;
    user-select: none;
  }
</style>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
/>

</head>
<body>

<div id="quest-log">
  <h2>Quest Log</h2>
  <div id="quests"><em>No active quests</em></div>
</div>

<div id="map-container">
  <button id="dm-toggle">Enable DM Mode</button>

  <div id="dm-form">
    <h3>Edit Location</h3>
    <label>
      Location Name:
      <input type="text" id="loc-name" />
    </label>

    <label>
      Quest Title:
      <input type="text" id="loc-quest" placeholder="Optional" />
    </label>

    <label>
      <input type="checkbox" id="loc-quest-active" />
      Toggle Quest Active
    </label>

    <button id="save-loc-btn">Save Location</button>
    <button id="cancel-loc-btn">Cancel</button>
  </div>

  <div id="map"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
  // Map and markers variables
  let map, markers = [];
  let dmMode = false;
  let tempCoords = null;
  let editingIndex = null;

  // Locations data: {name: string, coords: [lat,lng], quests: [questId]}
  let locations = [];

  // Quest data: {title: string, description: string, status: 'available'|'active'|'completed'|'removed'}
  let questData = [];

  // Initialize map
  function initMap() {
    map = L.map('map').setView([40, -100], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Add click event to add location when DM mode is on
    map.on('click', function(e) {
      if (!dmMode) return;
      tempCoords = [e.latlng.lat, e.latlng.lng];
      openDMForm(null);  // null means new location
    });

    renderMarkers();
  }

  // Render all markers on the map
  function renderMarkers() {
    // Remove old markers
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    locations.forEach((loc, i) => {
      // Check if location has an active quest
      const hasActiveQuest = loc.quests.some(
        qid => questData[qid] && questData[qid].status === 'active'
      );

      // Use star icon if active quest, otherwise default marker
      const icon = hasActiveQuest
        ? L.divIcon({
            className: 'star-icon',
            html: '‚≠ê',
            iconSize: [24, 24],
            iconAnchor: [12, 24]
          })
        : undefined;

      const marker = L.marker(loc.coords, { icon }).addTo(map);

      // Popup with location info and edit/delete buttons if DM mode on
      marker.on('click', () => {
        if (!dmMode) return;

        let questInfo = '';
        if (loc.quests.length > 0) {
          const activeQuestsForLoc = loc.quests
            .filter(qid => questData[qid] && questData[qid].status === 'active')
            .map(qid => '- ' + questData[qid].title)
            .join('<br>');

          if (activeQuestsForLoc) {
            questInfo = `<br><strong>Quests:</strong><br>${activeQuestsForLoc}`;
          }
        }

        marker.bindPopup(`
          <strong>${loc.name}</strong>
          ${questInfo}
          <br><br>
          <button onclick="editLocation(${i})">‚úèÔ∏è Edit</button>
          <button onclick="deleteLocation(${i})">üóëÔ∏è Delete</button>
        `).openPopup();
      });

      markers.push(marker);
    });
  }

  // Open DM form to edit or add location
  function openDMForm(index) {
    editingIndex = index;

    const form = document.getElementById('dm-form');
    form.style.display = 'block';

    if (index === null) {
      // New location
      document.getElementById('loc-name').value = '';
      document.getElementById('loc-quest').value = '';
      document.getElementById('loc-quest-active').checked = false;
    } else {
      // Edit existing
      const loc = locations[index];
      document.getElementById('loc-name').value = loc.name;

      if (loc.quests.length > 0) {
        const qid = loc.quests[0];
        const quest = questData[qid];
        if (quest && quest.status === 'active') {
          document.getElementById('loc-quest').value = quest.title;
          document.getElementById('loc-quest-active').checked = true;
        } else {
          document.getElementById('loc-quest').value = '';
          document.getElementById('loc-quest-active').checked = false;
        }
      } else {
        document.getElementById('loc-quest').value = '';
        document.getElementById('loc-quest-active').checked = false;
      }

      // Also set tempCoords to location coords for saving later
      tempCoords = loc.coords;
    }
  }

  // Save location from DM form
  function saveLocation() {
    const name = document.getElementById('loc-name').value.trim();
    const questTitle = document.getElementById('loc-quest').value.trim();
    const questActive = document.getElementById('loc-quest-active').checked;

    if (!name) {
      alert('Location name cannot be empty.');
      return;
    }

    let questsForLocation = [];

    if (questActive && questTitle) {
      // Add or update quest
      if (editingIndex !== null) {
        // Existing location
        if (locations[editingIndex].quests.length > 0) {
          // Update existing quest
          const qid = locations[editingIndex].quests[0];
          if (questData[qid]) {
            questData[qid].title = questTitle;
            questData[qid].status = 'active';
          } else {
            // Quest ID missing? Add new quest
            const newQuestId = questData.push({ title: questTitle, description: '', status: 'active' }) - 1;
            questsForLocation = [newQuestId];
          }
          questsForLocation = [qid];
        } else {
          // Add new quest
          const newQuestId = questData.push({ title: questTitle, description: '', status: 'active' }) - 1;
          questsForLocation = [newQuestId];
        }
      } else {
        // New location
        const newQuestId = questData.push({ title: questTitle, description: '', status: 'active' }) - 1;
        questsForLocation = [newQuestId];
      }
    }

    if (editingIndex !== null) {
      // Update existing location
      // If quest toggled off, mark old quests removed
      if (!questActive) {
        locations[editingIndex].quests.forEach(qid => {
          if (questData[qid]) questData[qid].status = 'removed';
        });
        questsForLocation = [];
      }

      locations[editingIndex].name = name;
      locations[editingIndex].coords = tempCoords;
      locations[editingIndex].quests = questsForLocation;
    } else {
      // Add new location
      locations.push({
        name,
        coords: tempCoords,
        quests: questsForLocation
      });
    }

    // Reset form and temp vars
    document.getElementById('loc-name').value = '';
    document.getElementById('loc-quest').value = '';
    document.getElementById('loc-quest-active').checked = false;
    document.getElementById('dm-form').style.display = 'none';
    tempCoords = null;
    editingIndex = null;

    renderMarkers();
    renderQuestLog();
  }

  // Delete location
  function deleteLocation(index) {
    if (!confirm(`Delete location "${locations[index].name}"?`)) return;

    // Remove quests associated with location
    locations[index].quests.forEach(qid => {
      if (questData[qid]) questData[qid].status = 'removed';
    });

    locations.splice(index, 1);

    renderMarkers();
    renderQuestLog();
  }

  // Edit location button handler (called from popup)
  function editLocation(index) {
    openDMForm(index);
  }

  // Render the quest log on left side
  function renderQuestLog() {
    const questLog = document.getElementById('quests');
    questLog.innerHTML = '';

    const activeQuests = questData.filter(q => q.status === 'active');

    if (activeQuests.length === 0) {
      questLog.innerHTML = '<em>No active quests</em>';
      return;
    }

    activeQuests.forEach((q, i) => {
      const div = document.createElement('div');
      div.className = 'quest ' + (q.status === 'completed' ? 'completed' : '');
      div.innerHTML = `<strong>${q.title}</strong>`;
      div.title = q.description || '';
      div.onclick = () => cycleQuestStatus(i);
      questLog.appendChild(div);
    });
  }

  // Cycle quest status on click: available ‚Üí active ‚Üí completed ‚Üí removed (removed quests don't show)
  function cycleQuestStatus(idx) {
    const statuses = ['available', 'active', 'completed'];
    const quest = questData[idx];
    let curIndex = statuses.indexOf(quest.status);
    curIndex = (curIndex + 1) % statuses.length;
    quest.status = statuses[curIndex];
    renderQuestLog();
    renderMarkers();
  }

  // DM mode toggle button
  const dmToggleBtn = document.getElementById('dm-toggle');
  dmToggleBtn.onclick = () => {
    dmMode = !dmMode;
    dmToggleBtn.textContent = dmMode ? "Disable DM Mode" : "Enable DM Mode";
    dmToggleBtn.style.backgroundColor = dmMode ? '#ddd' : '#fff';
    if (!dmMode) {
      document.getElementById('dm-form').style.display = 'none';
      tempCoords = null;
      editingIndex = null;
    }
    alert(`DM Mode ${dmMode ? 'enabled' : 'disabled'}. Click map to add or edit locations.`);
  };

  // Save and Cancel buttons handlers
  document.getElementById('save-loc-btn').onclick = saveLocation;
  document.getElementById('cancel-loc-btn').onclick = () => {
    document.getElementById('dm-form').style.display = 'none';
    tempCoords = null;
    editingIndex = null;
  };

  // Initialize everything
  window.onload = () => {
    initMap();
    renderQuestLog();
  };

  // Expose editLocation and deleteLocation globally so popup buttons can call them
  window.editLocation = editLocation;
  window.deleteLocation = deleteLocation;

</script>

</body>
</html>
