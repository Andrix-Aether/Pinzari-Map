<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>D&D Campaign Map - DM Mode</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 100vh; }
    .quest-log {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 8px;
      max-width: 300px;
      max-height: 90vh;
      overflow-y: auto;
      z-index: 1000;
    }
    .quest {
      margin-bottom: 10px;
      padding: 5px;
      border-left: 4px solid #444;
      cursor: pointer;
    }
    .quest.active { border-color: orange; }
    .quest.completed { border-color: green; text-decoration: line-through; }
    .leaflet-popup-content-wrapper { max-width: 250px; }

    #dm-toggle {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #fff;
      border: 1px solid #999;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      z-index: 1000;
      user-select: none;
    }

    #dm-form {
      position: absolute;
      top: 60px;
      left: 10px;
      background: #fff;
      border: 1px solid #999;
      padding: 10px;
      border-radius: 6px;
      display: none;
      width: 280px;
      z-index: 1000;
    }

    #dm-form label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }

    #dm-form input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 5px;
      font-size: 14px;
    }

    #dm-form button {
      margin-right: 8px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <button id="dm-toggle">Enable DM Mode</button>

  <div id="dm-form">
    <label for="loc-name">Location Name:</label>
    <input type="text" id="loc-name" placeholder="Enter location name" />

    <label for="loc-quest">Quest Title (optional):</label>
    <input type="text" id="loc-quest" placeholder="Enter quest title" />

    <div style="margin-top:10px;">
      <button id="save-btn">Save</button>
      <button id="cancel-btn">Cancel</button>
    </div>
  </div>

  <div class="quest-log" id="questLog">
    <h3>Quest Log</h3>
    <div id="quests"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
    });

    const imageUrl = './map.png';  // Change as needed
    const imageBounds = [[0, 0], [1000, 1000]];
    L.imageOverlay(imageUrl, imageBounds).addTo(map);
    map.fitBounds(imageBounds);

    let locations = [
      { name: 'Blue X Island', coords: [200, 200], quests: [0] },
      { name: 'Yellow X Island', coords: [600, 400], quests: [1] },
      { name: 'Mainland Port (Pink X)', coords: [950, 150], quests: [2] }
    ];

    const questData = [
      { title: "Find the Lost Artifact", description: "Something ancient was lost here.", status: "active" },
      { title: "Secure the Trade Route", description: "Pirates have been attacking merchants.", status: "available" },
      { title: "Diplomatic Envoy", description: "Send someone to negotiate peace.", status: "completed" }
    ];

    let markers = [];
    let dmMode = false;
    let tempCoords = null;    // For new or editing location coords
    let editingIndex = null;  // null means adding new location, else editing existing

    const dmToggleBtn = document.getElementById('dm-toggle');
    const dmForm = document.getElementById('dm-form');
    const locNameInput = document.getElementById('loc-name');
    const locQuestInput = document.getElementById('loc-quest');
    const saveBtn = document.getElementById('save-btn');
    const cancelBtn = document.getElementById('cancel-btn');

    // Toggle DM mode on/off
dmToggleBtn.onclick = () => {
  dmMode = !dmMode;
  dmToggleBtn.textContent = dmMode ? "Disable DM Mode" : "Enable DM Mode";
  dmToggleBtn.style.backgroundColor = dmMode ? '#ddd' : '#fff';
  if (!dmMode) {
    dmForm.style.display = 'none';
    tempCoords = null;
    editingIndex = null;
  }
  alert(`DM Mode ${dmMode ? 'enabled' : 'disabled'}. Click the map to add or manage locations.`);
};

    // Render quest log
    function renderQuestLog() {
      const questLog = document.getElementById('quests');
      questLog.innerHTML = '';
      questData.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = `quest ${q.status}`;
        div.innerHTML = `<strong>${q.title}</strong><br><small>${q.description}</small>`;
        div.onclick = () => cycleQuestStatus(i);
        questLog.appendChild(div);
      });
    }

    function cycleQuestStatus(index) {
      const statuses = ['available', 'active', 'completed'];
      const current = statuses.indexOf(questData[index].status);
      questData[index].status = statuses[(current + 1) % statuses.length];
      renderQuestLog();
      renderMarkers();
    }

    // Render all markers on map
    function renderMarkers() {
      // Remove old markers
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];

      locations.forEach((loc, i) => {
        const marker = L.marker(loc.coords).addTo(map);
        marker.on('click', (e) => {
          if (!dmMode) {
            // Just show popup with info if not DM mode
            const questList = loc.quests.length
              ? 'Quests:<br>' + loc.quests.map(id => '- ' + (questData[id]?.title || '')).join('<br>')
              : 'No quests';
            marker.bindPopup(`<strong>${loc.name}</strong><br>${questList}`).openPopup();
            return;
          }

          // In DM mode, open popup with edit/delete buttons
          const questList = loc.quests.length
            ? 'Quests:<br>' + loc.quests.map(id => '- ' + (questData[id]?.title || '')).join('<br>')
            : 'No quests';

          const popupContent = document.createElement('div');
          popupContent.innerHTML = `<strong>${loc.name}</strong><br>${questList}<br><br>`;

          const editBtn = document.createElement('button');
          editBtn.textContent = '✏️ Edit';
          editBtn.style.marginRight = '6px';
          editBtn.onclick = () => {
            editingIndex = i;
            tempCoords = loc.coords;
            locNameInput.value = loc.name;
            locQuestInput.value = loc.quests.length ? questData[loc.quests[0]]?.title || '' : '';
            dmForm.style.display = 'block';
            marker.closePopup();
          };

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = '🗑️ Delete';
          deleteBtn.onclick = () => {
            if (confirm(`Delete location "${loc.name}"?`)) {
              locations.splice(i, 1);
              dmForm.style.display = 'none';
              editingIndex = null;
              tempCoords = null;
              renderMarkers();
              renderQuestLog();
            }
            marker.closePopup();
          };

          popupContent.appendChild(editBtn);
          popupContent.appendChild(deleteBtn);

          marker.bindPopup(popupContent).openPopup();
        });

        markers.push(marker);
      });
    }

    // Map click to add new location in DM mode
    map.on('click', (e) => {
      if (!dmMode) return;
      tempCoords = [e.latlng.lat, e.latlng.lng];
      editingIndex = null;
      locNameInput.value = '';
      locQuestInput.value = '';
      dmForm.style.display = 'block';
    });

    // Save button handler for add/edit location
    saveBtn.onclick = () => {
      const name = locNameInput.value.trim();
      const questTitle = locQuestInput.value.trim();
      if (!name) {
        alert("Location name is required.");
        return;
      }

      let questIndex = null;
      if (questTitle) {
        // Check if quest already exists (simple check by title)
        questIndex = questData.findIndex(q => q.title.toLowerCase() === questTitle.toLowerCase());
        if (questIndex === -1) {
          // Add new quest if not found
          questIndex = questData.push({ title: questTitle, description: "Added in-session", status: "available" }) - 1;
        }
      }

      const newLoc = {
        name,
        coords: tempCoords,
        quests: questIndex !== null ? [questIndex] : []
      };

      if (editingIndex !== null) {
        locations[editingIndex] = newLoc;
      } else {
        locations.push(newLoc);
      }

      dmForm.style.display = 'none';
      locNameInput.value = '';
      locQuestInput.value = '';
      tempCoords = null;
      editingIndex = null;

      renderMarkers();
      renderQuestLog();
    };

    // Cancel button handler
    cancelBtn.onclick = () => {
      dmForm.style.display = 'none';
      locNameInput.value = '';
      locQuestInput.value = '';
      tempCoords = null;
      editingIndex = null;
    };

    renderQuestLog();
    renderMarkers();
  </script>
</body>
</html>
