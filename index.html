<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>D&D Campaign Map with Quests & Firebase Sync</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    display: flex;
    height: 100vh;
  }
  #quest-log {
    width: 250px;
    border-right: 1px solid #ccc;
    padding: 10px;
    overflow-y: auto;
    background: #f9f9f9;
  }
  #quest-log h2 {
    margin-top: 0;
  }
  #quests {
    margin-top: 10px;
  }
  .quest {
    border: 1px solid #aaa;
    border-radius: 4px;
    padding: 6px;
    margin-bottom: 6px;
    background: #fff;
    cursor: pointer;
  }
  .quest.completed {
    background: #d4ffd4;
    text-decoration: line-through;
  }
  #map-container {
    flex: 1;
    position: relative;
  }
  #map {
    width: 100%;
    height: 100%;
  }
  #dm-toggle {
    position: absolute;
    top: 10px; left: 10px;
    z-index: 1000;
    padding: 8px 12px;
    background: #fff;
    border: 1px solid #ccc;
    cursor: pointer;
  }
  #dm-form {
    position: absolute;
    top: 50px; left: 10px;
    z-index: 1000;
    background: #fff;
    padding: 10px;
    border: 1px solid #ccc;
    max-width: 320px;
    display: none;
  }
  #dm-form label {
    display: block;
    margin-top: 8px;
  }
  #dm-form input[type=text] {
    width: 100%;
    padding: 4px;
    box-sizing: border-box;
  }
  #dm-form button {
    margin-top: 10px;
    margin-right: 10px;
  }

  /* Star icon for quest marker */
  .star-icon {
    font-size: 24px;
    color: gold;
    text-shadow: 1px 1px 2px black;
    user-select: none;
  }
</style>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
/>

</head>
<body>

<div id="quest-log">
  <h2>Quest Log</h2>
  <div id="quests"><em>No active quests</em></div>
</div>

<div id="map-container">
  <button id="dm-toggle">Enable DM Mode</button>

  <div id="dm-form">
    <h3>Edit Location</h3>
    <label>
      Location Name:
      <input type="text" id="loc-name" />
    </label>

    <label>
      Quest Title:
      <input type="text" id="loc-quest" placeholder="Optional" />
    </label>

    <button id="toggle-quest-btn">Activate Quest</button>

    <br />
    <button id="save-loc-btn">Save Location</button>
    <button id="cancel-loc-btn">Cancel</button>
  </div>

  <div id="map"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<!-- Firebase JS SDK (using version 9 modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

  // Your Firebase config here (replace with your actual keys!)
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // State variables
  let map, markers = [];
  let dmMode = false;
  let tempCoords = null;
  let editingIndex = null;

  // Data arrays:
  // We'll keep local copies but all saved in firebase
  let locations = []; // Each location: { id, name, coords: [lat,lng], questId or null }
  let quests = {}; // Keyed by questId: { id, title, status }

  // Initialize the map
  function initMap() {
    map = L.map('map').setView([40, -100], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    map.on('click', (e) => {
      if (!dmMode) return;
      tempCoords = [e.latlng.lat, e.latlng.lng];
      openDMForm(null);
    });
  }

  // Render markers on the map
  function renderMarkers() {
    // Remove old markers
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    locations.forEach((loc, i) => {
      // Check if location has active quest
      let hasActiveQuest = false;
      if (loc.questId && quests[loc.questId]) {
        hasActiveQuest = quests[loc.questId].status === 'active';
      }

      const icon = hasActiveQuest
        ? L.divIcon({
            className: 'star-icon',
            html: '‚≠ê',
            iconSize: [24, 24],
            iconAnchor: [12, 24]
          })
        : undefined;

      const marker = L.marker(loc.coords, { icon }).addTo(map);

      // Popup content
      let popupHtml = `<strong>${loc.name}</strong>`;

      if (loc.questId && quests[loc.questId] && quests[loc.questId].status === 'active') {
        popupHtml += `<br><strong>Quest:</strong> ${quests[loc.questId].title}`;
      }

      if (dmMode) {
        popupHtml += `<br><br>
          <button onclick="editLocation(${i})">‚úèÔ∏è Edit</button>
          <button onclick="deleteLocation(${i})">üóëÔ∏è Delete</button>`;
      }

      marker.bindPopup(popupHtml);

      markers.push(marker);
    });
  }

  // Render quest log
  function renderQuestLog() {
    const questLog = document.getElementById('quests');
    questLog.innerHTML = '';

    // Filter active quests
    const activeQuests = Object.values(quests).filter(q => q.status === 'active');

    if (activeQuests.length === 0) {
      questLog.innerHTML = '<em>No active quests</em>';
      return;
    }

    activeQuests.forEach(q => {
      const div = document.createElement('div');
      div.className = 'quest';
      div.textContent = q.title;
      div.title = q.description || '';
      div.style.userSelect = "none";
      // Optionally: add click to toggle completed status or other
      questLog.appendChild(div);
    });
  }

  // Open the DM form to add/edit location
  function openDMForm(index) {
    editingIndex = index;
    const form = document.getElementById('dm-form');
    form.style.display = 'block';

    if (index === null) {
      // New location form
      document.getElementById('loc-name').value = '';
      document.getElementById('loc-quest').value = '';
      document.getElementById('toggle-quest-btn').textContent = 'Activate Quest';
      tempCoords = tempCoords; // Already set on map click
    } else {
      const loc = locations[index];
      document.getElementById('loc-name').value = loc.name;

      if (loc.questId && quests[loc.questId]) {
        document.getElementById('loc-quest').value = quests[loc.questId].title;
        document.getElementById('toggle-quest-btn').textContent = quests[loc.questId].status === 'active' ? 'Deactivate Quest' : 'Activate Quest';
      } else {
        document.getElementById('loc-quest').value = '';
        document.getElementById('toggle-quest-btn').textContent = 'Activate Quest';
      }

      tempCoords = loc.coords;
    }
  }

  // Toggle quest button handler
  async function toggleQuest() {
    const questTitle = document.getElementById('loc-quest').value.trim();

    if (!questTitle) {
      alert("Please enter a quest title to toggle quest.");
      return;
    }

    if (editingIndex === null) {
      // New location - quests require a location, so just toggle UI button text
      if (document.getElementById('toggle-quest-btn').textContent === 'Activate Quest') {
        document.getElementById('toggle-quest-btn').textContent = 'Deactivate Quest';
      } else {
        document.getElementById('toggle-quest-btn').textContent = 'Activate Quest';
      }
      return;
    }

    let loc = locations[editingIndex];

    // If location has quest, toggle it off (remove quest)
    if (loc.questId && quests[loc.questId]) {
      // Toggle off quest if currently active
      if (quests[loc.questId].status === 'active') {
        await removeQuest(loc.questId);
        loc.questId = null;
        await saveLocationToFirebase(loc);
        document.getElementById('toggle-quest-btn').textContent = 'Activate Quest';
        renderQuestLog();
        renderMarkers();
        return;
      }
    }

    // Else toggle on (create or reactivate quest)
    if (loc.questId && quests[loc.questId]) {
      // Reactivate existing quest
      quests[loc.questId].status = 'active';
      quests[loc.questId].title = questTitle;
      await saveQuestToFirebase(quests[loc.questId]);
      document.getElementById('toggle-quest-btn').textContent = 'Deactivate Quest';
      renderQuestLog();
      renderMarkers();
    } else {
      // Create new quest
      const newQuestRef = push(ref(db, 'quests'));
      const newQuest = {
        id: newQuestRef.key,
        title: questTitle,
        status: 'active',
        description: ''
      };
      await set(newQuestRef, newQuest);

      // Link to location
      loc.questId = newQuest.id;
      await saveLocationToFirebase(loc);
      document.getElementById('toggle-quest-btn').textContent = 'Deactivate Quest';
      renderQuestLog();
      renderMarkers();
    }
  }

  // Save location handler
  async function saveLocation() {
    const name = document.getElementById('loc-name').value.trim();
    const questTitle = document.getElementById('loc-quest').value.trim();

    if (!name) {
      alert('Location name cannot be empty.');
      return;
    }

    if (editingIndex === null) {
      // New location
      const newLocRef = push(ref(db, 'locations'));
      const newLoc = {
        id: newLocRef.key,
        name,
        coords: tempCoords,
        questId: null
      };
      await set(newLocRef, newLoc);

      // If quest toggle says activated, create quest
      if (document.getElementById('toggle-quest-btn').textContent === 'Deactivate Quest' && questTitle) {
        const newQuestRef = push(ref(db, 'quests'));
        const newQuest = {
          id: newQuestRef.key,
          title: questTitle,
          status: 'active',
          description: ''
        };
        await set(newQuestRef, newQuest);

        newLoc.questId = newQuest.id;
        await set(newLocRef, newLoc); // Update location with questId
      }
    } else {
      // Update existing location
      let loc = locations[editingIndex];
      loc.name = name;
      loc.coords = tempCoords;

      // Quest toggle state determines if quest stays or removed
      if (document.getElementById('toggle-quest-btn').textContent === 'Deactivate Quest') {
        // Quest active - update or create
        if (loc.questId && quests[loc.questId]) {
          quests[loc.questId].title = questTitle;
          quests[loc.questId].status = 'active';
          await saveQuestToFirebase(quests[loc.questId]);
        } else if (questTitle) {
          // Create quest if missing
          const newQuestRef = push(ref(db, 'quests'));
          const newQuest = {
            id: newQuestRef.key,
            title: questTitle,
            status: 'active',
            description: ''
          };
          await set(newQuestRef, newQuest);
          loc.questId = newQuest.id;
        }
      } else {
        // Quest deactivated - remove quest if exists
        if (loc.questId && quests[loc.questId]) {
          await removeQuest(loc.questId);
          loc.questId = null;
        }
      }

      await saveLocationToFirebase(loc);
    }

    // Reset form
    document.getElementById('loc-name').value = '';
    document.getElementById('loc-quest').value = '';
    document.getElementById('toggle-quest-btn').textContent = 'Activate Quest';
    document.getElementById('dm-form').style.display = 'none';
    tempCoords = null;
    editingIndex = null;
  }

  // Remove quest from Firebase and local state
  async function removeQuest(questId) {
    await remove(ref(db, 'quests/' + questId));
    delete quests[questId];

    // Also remove from any locations referencing it
    for (const loc of locations) {
      if (loc.questId === questId) {
        loc.questId = null;
        await saveLocationToFirebase(loc);
      }
    }
  }

  // Save a single location to Firebase
  async function saveLocationToFirebase(loc) {
    await set(ref(db, 'locations/' + loc.id), loc);
  }

  // Save a single quest to Firebase
  async function saveQuestToFirebase(quest) {
    await set(ref(db, 'quests/' + quest.id), quest);
  }

  // Delete location handler
  async function deleteLocation(index) {
    if (!confirm(`Delete location "${locations[index].name}"?`)) return;
    const loc = locations[index];

    // Remove associated quest if any
    if (loc.questId) {
      await removeQuest(loc.questId);
    }

    await remove(ref(db, 'locations/' + loc.id));
  }

  // Edit location handler
  function editLocation(index) {
    openDMForm(index);
  }

  // Setup listeners on Firebase to keep local state in sync
  function setupFirebaseListeners() {
    // Listen to locations
    const locationsRef = ref(db, 'locations');
    onValue(locationsRef, (snapshot) => {
      const val = snapshot.val() || {};
      locations = Object.values(val);
      renderMarkers();
    });

    // Listen to quests
    const questsRef = ref(db, 'quests');
    onValue(questsRef, (snapshot) => {
      quests = snapshot.val() || {};
      renderQuestLog();
      renderMarkers();
    });
  }

  // DM mode toggle button
  const dmToggleBtn = document.getElementById('dm-toggle');
  dmToggleBtn.onclick = () => {
    dmMode = !dmMode;
    dmToggleBtn.textContent = dmMode ? "Disable DM Mode" : "Enable DM Mode";
    dmToggleBtn.style.backgroundColor = dmMode ? '#ddd' : '#fff';
    if (!dmMode) {
      document.getElementById('dm-form').style.display = 'none';
      tempCoords = null;
      editingIndex = null;
    }
    alert(`DM Mode ${dmMode ? 'enabled' : 'disabled'}. Click map to add or edit locations.`);
  };

  // Button event bindings
  document.getElementById('save-loc-btn').onclick = saveLocation;
  document.getElementById('cancel-loc-btn').onclick = () => {
    document.getElementById('dm-form').style.display = 'none';
    tempCoords = null;
    editingIndex = null;
  };
  document.getElementById('toggle-quest-btn').onclick = toggleQuest;

  // Initialize app
  window.onload = () => {
    initMap();
    setupFirebaseListeners();
  };

  // Expose functions for popup buttons
  window.editLocation = editLocation;
  window.deleteLocation = deleteLocation;

</script>

</body>
</html>
